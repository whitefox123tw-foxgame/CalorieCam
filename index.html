HTML
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ˆå±¬é£²é£Ÿæ—¥è¨˜</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f0f4f8; color: #333; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="number"], input[type="text"], input[type="password"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { display: block; width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 15px; font-weight: bold; }
        button:hover { background: #0056b3; }
        
        .dashboard { display: flex; justify-content: space-between; text-align: center; background: #eef2f5; padding: 15px; border-radius: 8px; margin-top: 15px;}
        .stat { flex: 1; }
        .stat span { display: block; font-size: 24px; font-weight: bold; color: #007bff; }
        .stat.remaining span { color: #28a745; }
        .stat.consumed span { color: #dc3545; }

        #previewContainer { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc; }
        
        .loading { text-align: center; display: none; color: #ff8c00; font-weight: bold; margin-top: 10px;}
        
        .history-item { background: #fff8e1; padding: 15px; border-left: 4px solid #ffc107; margin-top: 10px; border-radius: 4px; display: flex; gap: 15px; position: relative; align-items: flex-start;}
        .history-photos-container { display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; width: 70px;}
        .history-photo { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        
        .history-content { flex: 1; display: flex; flex-direction: column; }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;}
        .history-desc { font-size: 13px; color: #555; white-space: pre-line; margin-bottom: 10px; line-height: 1.4;}
        
        .meal-tag { background: #ffe082; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #d84315; display: inline-block;}
        .delete-btn { width: auto; padding: 5px 10px; background: #dc3545; font-size: 13px; margin-top: auto; align-self: flex-end;}
        .delete-btn:hover { background: #c82333; }
        .date-picker-container { text-align: center; margin-bottom: 15px; background: #eef2f5; padding: 10px; border-radius: 8px;}
    </style>
</head>
<body>

<div class="card">
    <input type="password" id="apiKey" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Gemini API Key">
</div>

<div class="card">
    <h2>1ï¸âƒ£ æˆ‘çš„å°ˆå±¬æ•¸å€¼</h2>
    <div style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>æ€§åˆ¥</label><select id="gender"><option value="female" selected>å¥³æ€§</option><option value="male">ç”·æ€§</option></select></div>
        <div style="flex: 1;"><label>å¹´é½¡</label><input type="number" id="age" value="45"></div>
    </div>
    <div style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>èº«é«˜ (cm)</label><input type="number" id="height" placeholder="ä¾‹å¦‚: 160"></div>
        <div style="flex: 1;"><label>é«”é‡ (kg)</label><input type="number" id="weight" placeholder="ä¾‹å¦‚: 55"></div>
    </div>
    <button onclick="calculateTDEE()">å„²å­˜è¨­å®šä¸¦è¨ˆç®—ç›®æ¨™</button>
</div>

<div class="card">
    <h2>2ï¸âƒ£ æ—¥å¸¸ç†±é‡è¿½è¹¤</h2>
    <div class="dashboard">
        <div class="stat">æ¯æ—¥ç›®æ¨™<br><span id="dailyGoalDisplay">0</span></div>
        <div class="stat consumed">å·²æ”å–<br><span id="consumedDisplay">0</span></div>
        <div class="stat remaining">é‚„å¯åƒ<br><span id="remainingDisplay">0</span></div>
    </div>
</div>

<div class="card">
    <h2>3ï¸âƒ£ ç´€éŒ„é¤é»ç®—ç†±é‡</h2>
    
    <label>ğŸ“· æ‹ç…§ä¸Šå‚³ (é¸å¡«ï¼šå¯é¸å¤šå¼µï¼Œæ²’ç…§ç‰‡ä¹Ÿå¯ä¸å‚³)</label>
    <input type="file" id="imageInput" accept="image/*" multiple>
    
    <div id="previewContainer"></div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <div style="flex: 1;">
            <label>å“ªä¸€é¤ï¼Ÿ</label>
            <select id="mealType">
                <option value="æ—©é¤">æ—©é¤ ğŸ³</option>
                <option value="åˆé¤" selected>åˆé¤ ğŸ±</option>
                <option value="æ™šé¤">æ™šé¤ ğŸ½ï¸</option>
                <option value="é»å¿ƒ">é»å¿ƒ/å®µå¤œ ğŸ°</option>
            </select>
        </div>
        <div style="flex: 2;">
            <label>âœï¸ é¤é»å‚™è¨» / èœå (é¸å¡«)</label>
            <input type="text" id="foodHint" placeholder="ä¾‹ï¼šè‚‰ç‡¥ç±³ç²‰ (è‹¥ç„¡ç…§ç‰‡å‰‡å¿…å¡«)">
        </div>
    </div>
    
    <button id="analyzeBtn" onclick="analyzeFood()">ä¸Šå‚³åˆ†æ</button>
    <div id="loading" class="loading">å°G æ­£åœ¨èªçœŸå¹«å¦³åˆ†æç†±é‡ä¸­... ğŸ³</div>
</div>

<div class="card">
    <h2>ğŸ½ï¸ é£²é£Ÿåœ–é‘‘æŸ¥è©¢</h2>
    <div class="date-picker-container">
        <label style="display: inline-block; margin-top: 0;">ğŸ“… é¸æ“‡æ—¥æœŸï¼š</label>
        <input type="date" id="historyDate" onchange="changeDate()" style="width: auto; display: inline-block; margin-left: 10px;">
    </div>
    <button onclick="clearHistory()" style="background: #6c757d; margin-bottom: 15px;">ğŸ—‘ï¸ æ¸…é™¤ã€Œæ­¤æ—¥æœŸã€çš„æ‰€æœ‰ç´€éŒ„</button>
    <div id="historyList"></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let dailyGoal = 0;
    let consumed = 0;
    let foodHistory = [];
    let currentDateKey = ""; 

    function getLocalYYYYMMDD(dateObj = new Date()) {
        const tzOffset = dateObj.getTimezoneOffset() * 60000;
        return (new Date(dateObj - tzOffset)).toISOString().split('T')[0];
    }

    window.onload = () => {
        currentDateKey = getLocalYYYYMMDD();
        document.getElementById('historyDate').value = currentDateKey;
        loadSettings();
        loadHistory(currentDateKey);
        updateDashboard();
    };

    window.calculateTDEE = function() {
        const gender = document.getElementById('gender').value;
        const age = parseInt(document.getElementById('age').value);
        const height = parseInt(document.getElementById('height').value);
        const weight = parseInt(document.getElementById('weight').value);
        if(!height || !weight) { alert("è«‹å¡«å¯«èº«é«˜å’Œé«”é‡å–”ï¼"); return; }

        let bmr = (10 * weight) + (6.25 * height) - (5 * age);
        bmr = (gender === 'female') ? bmr - 161 : bmr + 5;
        dailyGoal = Math.round(bmr * 1.375);
        
        localStorage.setItem('calorieGoal', dailyGoal);
        localStorage.setItem('userProfile', JSON.stringify({gender, age, height, weight}));
        alert(`è¨­å®šå®Œæˆï¼å»ºè­°ç†±é‡ç´„ç‚º ${dailyGoal} å¤§å¡ã€‚`);
        updateDashboard();
    };

    function loadSettings() {
        const savedGoal = localStorage.getItem('calorieGoal');
        if(savedGoal) dailyGoal = parseInt(savedGoal);
        const profile = JSON.parse(localStorage.getItem('userProfile'));
        if(profile) {
            document.getElementById('gender').value = profile.gender;
            document.getElementById('age').value = profile.age;
            document.getElementById('height').value = profile.height;
            document.getElementById('weight').value = profile.weight;
        }
    }

    function loadHistory(dateStr) {
        const savedHistory = localStorage.getItem('foodHistory_' + dateStr);
        if(savedHistory) {
            foodHistory = JSON.parse(savedHistory);
            consumed = foodHistory.reduce((total, item) => total + item.calories, 0);
        } else {
            foodHistory = [];
            consumed = 0;
        }
    }

    window.changeDate = function() {
        currentDateKey = document.getElementById('historyDate').value;
        loadHistory(currentDateKey);
        updateDashboard();
    }

    function updateDashboard() {
        document.getElementById('dailyGoalDisplay').innerText = dailyGoal;
        document.getElementById('consumedDisplay').innerText = consumed;
        const remaining = dailyGoal - consumed;
        const remainElem = document.getElementById('remainingDisplay');
        remainElem.innerText = remaining;
        remainElem.style.color = remaining < 0 ? '#dc3545' : '#28a745';
        renderHistoryList();
    }

    document.getElementById('imageInput').addEventListener('change', function(event) {
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.innerHTML = ''; 
        const files = event.target.files;
        if (files) {
            for(let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(files[i]);
            }
        }
    });

    async function fileToGenerativePart(file) {
        const base64EncodedDataPromise = new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });
        return { inlineData: { data: await base64EncodedDataPromise, mimeType: file.type } };
    }

    function compressImage(file, maxSize = 120) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    window.analyzeFood = async function() {
        const apiKey = document.getElementById('apiKey').value;
        const fileInput = document.getElementById('imageInput');
        const hintInput = document.getElementById('foodHint').value.trim(); 
        const mealType = document.getElementById('mealType').value; 
        const loadingDiv = document.getElementById('loading');
        
        const files = fileInput.files;
        const hasPhotos = files.length > 0;

        if (!apiKey) { alert("è¨˜å¾—å…ˆè¼¸å…¥ API Key å–”ï¼"); return; }
        
        // --- é€™è£¡å°±æ˜¯é˜²å‘†é‚è¼¯ï¼šæ²’ç…§ç‰‡ä¹Ÿæ²’æ–‡å­—ï¼Œæ‰æœƒé˜»æ“‹ ---
        if (!hasPhotos && hintInput === "") { 
            alert("è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç…§ç‰‡ï¼Œæˆ–è€…åœ¨å‚™è¨»æ¬„æ‰“å­—å‘Šè¨´å°Gåƒäº†ä»€éº¼å–”ï¼(å…©è€…æ“‡ä¸€å³å¯)"); 
            return; 
        }
        if (dailyGoal === 0) { alert("è«‹å…ˆåœ¨ä¸Šé¢å®Œæˆã€Œæˆ‘çš„å°ˆå±¬æ•¸å€¼ã€è¨­å®šä¸¦å„²å­˜ï¼"); return; }

        loadingDiv.style.display = 'block';

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-2.5-flash", 
                generationConfig: { responseMimeType: "application/json" }
            });

            let promptParts = [];
            let thumbnailsArray = [];

            if (hasPhotos) {
                // æƒ…å¢ƒ 1 & 2ï¼šæœ‰ç…§ç‰‡ (ä¸ç®¡æœ‰æ²’æœ‰æ‰“å­—éƒ½é©ç”¨)
                let hintInstruction = hintInput !== "" ? `ã€é‡è¦æç¤ºã€‘ï¼šä½¿ç”¨è€…è¡¨ç¤ºé€™äº›é¤é»åŒ…å«ã€Œ${hintInput}ã€ã€‚è«‹å‹™å¿…åƒè€ƒé€™å€‹æç¤ºã€‚` : "";
                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç‡Ÿé¤Šå°ˆå®¶ã€‚è«‹ç¶œåˆè©•ä¼°ã€Œé€™å¹¾å¼µåœ–ç‰‡ã€ä¸­çš„ã€Œæ‰€æœ‰é£Ÿç‰©ã€ï¼Œä¸¦ä¼°ç®—ç¸½ç†±é‡ã€‚
                ${hintInstruction}
                å›å‚³æ ¼å¼å¿…é ˆæ˜¯æ¨™æº–çš„ JSONï¼š
                {
                    "food_name": "èœè‰²ç¸½ç¨±",
                    "calories": ç¸½ç†±é‡æ•¸å­— (å¿…é ˆæ˜¯ç´”ç²¹çš„ã€Œæ•´æ•¸æ•¸å­—ã€),
                    "description": "è«‹è©³ç´°åˆ—å‡ºã€åœ–ç‰‡ä¸­æ¯ä¸€æ¨£é£Ÿç‰©çš„å€‹åˆ¥ä¼°ç®—ç†±é‡ã€‘ï¼Œä¸¦ç°¡å–®èªªæ˜ç‡Ÿé¤Šç‹€æ…‹ã€‚"
                }
                æ³¨æ„ï¼šè«‹çµ¦å‡ºåˆç†çš„ä¼°ç®—æ•´æ•¸ï¼Œcalories çµ•å°ä¸å¯ä»¥å¡«å¯« 0ã€‚`;
                
                promptParts.push(prompt);
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    promptParts.push(await fileToGenerativePart(file));
                    thumbnailsArray.push(await compressImage(file)); 
                }
            } else {
                // æƒ…å¢ƒ 3ï¼šæ²’ç…§ç‰‡ï¼Œç´”æ‰“å­—
                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç‡Ÿé¤Šå°ˆå®¶ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…çš„æ–‡å­—æè¿°ï¼šã€Œ${hintInput}ã€ï¼Œä¼°ç®—é€™äº›é£Ÿç‰©çš„ç¸½ç†±é‡ã€‚
                å›å‚³æ ¼å¼å¿…é ˆæ˜¯æ¨™æº–çš„ JSONï¼š
                {
                    "food_name": "èœè‰²ç¸½ç¨±",
                    "calories": ç¸½ç†±é‡æ•¸å­— (å¿…é ˆæ˜¯ç´”ç²¹çš„ã€Œæ•´æ•¸æ•¸å­—ã€),
                    "description": "è«‹è©³ç´°åˆ—å‡ºã€æ¯ä¸€æ¨£é£Ÿç‰©çš„å€‹åˆ¥ä¼°ç®—ç†±é‡ã€‘ï¼Œä¸¦ç°¡å–®èªªæ˜ç‡Ÿé¤Šç‹€æ…‹ã€‚"
                }
                æ³¨æ„ï¼šè«‹çµ¦å‡ºåˆç†çš„ä¼°ç®—æ•´æ•¸ï¼Œcalories çµ•å°ä¸å¯ä»¥å¡«å¯« 0ã€‚`;
                
                promptParts.push(prompt);
            }

            const result = await model.generateContent(promptParts);
            const responseText = await result.response.text();
            
            const foodData = JSON.parse(responseText);

            if(foodData.calories > 0) {
                foodData.meal_type = mealType;
                foodData.thumbnails = thumbnailsArray; 
                
                foodHistory.push(foodData);
                consumed += foodData.calories;
                
                localStorage.setItem('foodHistory_' + currentDateKey, JSON.stringify(foodHistory));
                
                document.getElementById('foodHint').value = ""; 
                fileInput.value = ""; 
                document.getElementById('previewContainer').innerHTML = ''; 
                
                updateDashboard();
            } else {
                alert("å°G ç„¡æ³•ä¼°ç®—ç†±é‡ï¼Œè«‹å˜—è©¦æä¾›æ›´è©³ç´°çš„æè¿°æˆ–ç…§ç‰‡å–”ï¼");
            }

        } catch (error) {
            console.error(error);
            alert("å“å‘€ï¼Œåˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤äº†ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key æ˜¯å¦æ­£ç¢ºã€‚");
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    window.deleteSingleItem = function(index) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†é¤é»ç´€éŒ„å—ï¼Ÿ")) {
            consumed -= foodHistory[index].calories;
            foodHistory.splice(index, 1);
            
            if (foodHistory.length === 0) {
                localStorage.removeItem('foodHistory_' + currentDateKey);
                consumed = 0;
            } else {
                localStorage.setItem('foodHistory_' + currentDateKey, JSON.stringify(foodHistory));
            }
            updateDashboard();
        }
    }

    function renderHistoryList() {
        const listDiv = document.getElementById('historyList');
        listDiv.innerHTML = '';
        
        if (foodHistory.length === 0) {
            listDiv.innerHTML = '<p style="text-align: center; color: #888;">é€™å¤©é‚„æ²’æœ‰ç´€éŒ„å–”ï¼</p>';
            return;
        }

        foodHistory.forEach((item, index) => {
            let imagesHtml = '';
            if (item.thumbnails && item.thumbnails.length > 0) {
                item.thumbnails.forEach(src => {
                    imagesHtml += `<img src="${src}" alt="é£Ÿç‰©ç…§ç‰‡" class="history-photo">`;
                });
            } else {
                imagesHtml = `<div class="history-photo" style="background:#f8f9fa; display:flex; align-items:center; justify-content:center; font-size:12px; color:#888; border: 1px dashed #ccc;">âœï¸ ç­†è¨˜</div>`;
            }

            listDiv.innerHTML += `
                <div class="history-item">
                    <div class="history-photos-container">
                        ${imagesHtml}
                    </div>
                    <div class="history-content">
                        <div class="history-header">
                            <div>
                                <span class="meal-tag">${item.meal_type || 'æœªåˆ†é¡'}</span>
                                <strong style="display:block; font-size: 16px;">${item.food_name}</strong>
                            </div>
                            <span style="color: #dc3545; font-weight: bold; font-size: 18px;">+${item.calories} å¡</span>
                        </div>
                        <div class="history-desc">${item.description}</div>
                        <button class="delete-btn" onclick="deleteSingleItem(${index})">åˆªé™¤</button>
                    </div>
                </div>
            `;
        });
    }

    window.clearHistory = function() {
        if(confirm(`ç¢ºå®šè¦æ¸…é™¤ ${currentDateKey} çš„ã€Œæ‰€æœ‰ã€é£²é£Ÿç´€éŒ„å—ï¼Ÿ`)) {
            localStorage.removeItem('foodHistory_' + currentDateKey);
            foodHistory = [];
            consumed = 0;
            updateDashboard();
        }
    }
</script>

</body>
</html>