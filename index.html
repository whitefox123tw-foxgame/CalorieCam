<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ˆå±¬é£²é£Ÿæ—¥è¨˜</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f0f4f8; color: #333; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* è¡¨å–®èˆ‡æŒ‰éˆ•è¨­è¨ˆ */
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { display: block; width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 15px; font-weight: bold; }
        button:hover { background: #0056b3; }
        
        /* æ•¸æ“šé¡¯ç¤ºå€ */
        .dashboard { display: flex; justify-content: space-between; text-align: center; background: #eef2f5; padding: 15px; border-radius: 8px; margin-top: 15px;}
        .stat { flex: 1; }
        .stat span { display: block; font-size: 24px; font-weight: bold; color: #007bff; }
        .stat.remaining span { color: #28a745; }
        .stat.consumed span { color: #dc3545; }

        /* åœ–ç‰‡é è¦½èˆ‡ç´€éŒ„æ¸…å–® */
        #preview { max-width: 100%; border-radius: 8px; margin-top: 10px; display: none; }
        .loading { text-align: center; display: none; color: #ff8c00; font-weight: bold; margin-top: 10px;}
        
        /* æ­·å²ç´€éŒ„æ–°æ’ç‰ˆï¼šåŠ å…¥ç¸®åœ–çš„ç©ºé–“ */
        .history-item { background: #fff8e1; padding: 15px; border-left: 4px solid #ffc107; margin-top: 10px; border-radius: 4px; display: flex; gap: 15px; position: relative; align-items: flex-start;}
        .history-photo { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; flex-shrink: 0;}
        .history-content { flex: 1; display: flex; flex-direction: column; }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;}
        .history-desc { font-size: 13px; color: #555; white-space: pre-line; margin-bottom: 10px; line-height: 1.4;}
        
        /* æ¨™ç±¤èˆ‡æŒ‰éˆ•æ¨£å¼ */
        .meal-tag { background: #ffe082; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #d84315; display: inline-block;}
        .delete-btn { width: auto; padding: 5px 10px; background: #dc3545; font-size: 13px; margin-top: auto; align-self: flex-end;}
        .delete-btn:hover { background: #c82333; }
        .date-picker-container { text-align: center; margin-bottom: 15px; background: #eef2f5; padding: 10px; border-radius: 8px;}
    </style>
</head>
<body>

<div class="card">
    <input type="password" id="apiKey" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Gemini API Key">
</div>

<div class="card">
    <h2>1ï¸âƒ£ æˆ‘çš„å°ˆå±¬æ•¸å€¼</h2>
    <div style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>æ€§åˆ¥</label><select id="gender"><option value="female" selected>å¥³æ€§</option><option value="male">ç”·æ€§</option></select></div>
        <div style="flex: 1;"><label>å¹´é½¡</label><input type="number" id="age" value="45"></div>
    </div>
    <div style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>èº«é«˜ (cm)</label><input type="number" id="height" placeholder="ä¾‹å¦‚: 160"></div>
        <div style="flex: 1;"><label>é«”é‡ (kg)</label><input type="number" id="weight" placeholder="ä¾‹å¦‚: 55"></div>
    </div>
    <button onclick="calculateTDEE()">å„²å­˜è¨­å®šä¸¦è¨ˆç®—ç›®æ¨™</button>
</div>

<div class="card">
    <h2>2ï¸âƒ£ æ—¥å¸¸ç†±é‡è¿½è¹¤</h2>
    <div class="dashboard">
        <div class="stat">æ¯æ—¥ç›®æ¨™<br><span id="dailyGoalDisplay">0</span></div>
        <div class="stat consumed">å·²æ”å–<br><span id="consumedDisplay">0</span></div>
        <div class="stat remaining">é‚„å¯åƒ<br><span id="remainingDisplay">0</span></div>
    </div>
</div>

<div class="card">
    <h2>3ï¸âƒ£ æ‹ä¸‹é¤é»ç®—ç†±é‡</h2>
    <input type="file" id="imageInput" accept="image/*">
    <img id="preview" alt="ç…§ç‰‡é è¦½">
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <div style="flex: 1;">
            <label>å“ªä¸€é¤ï¼Ÿ</label>
            <select id="mealType">
                <option value="æ—©é¤">æ—©é¤ ğŸ³</option>
                <option value="åˆé¤" selected>åˆé¤ ğŸ±</option>
                <option value="æ™šé¤">æ™šé¤ ğŸ½ï¸</option>
                <option value="é»å¿ƒ">é»å¿ƒ/å®µå¤œ ğŸ°</option>
            </select>
        </div>
        <div style="flex: 2;">
            <label>çµ¦å°Gçš„æç¤º (é¸å¡«)</label>
            <input type="text" id="foodHint" placeholder="ä¾‹ï¼šè‚‰ç‡¥ç±³ç²‰ã€é˜¿çµ¦...">
        </div>
    </div>
    
    <button id="analyzeBtn" onclick="analyzeFood()">ä¸Šå‚³åˆ†æ</button>
    <div id="loading" class="loading">å°G æ­£åœ¨èªçœŸå¹«å¦³åˆ†æç†±é‡ä¸­... ğŸ³</div>
</div>

<div class="card">
    <h2>ğŸ½ï¸ é£²é£Ÿåœ–é‘‘æŸ¥è©¢</h2>
    <div class="date-picker-container">
        <label style="display: inline-block; margin-top: 0;">ğŸ“… é¸æ“‡æ—¥æœŸï¼š</label>
        <input type="date" id="historyDate" onchange="changeDate()" style="width: auto; display: inline-block; margin-left: 10px;">
    </div>
    <button onclick="clearHistory()" style="background: #6c757d; margin-bottom: 15px;">ğŸ—‘ï¸ æ¸…é™¤ã€Œæ­¤æ—¥æœŸã€çš„æ‰€æœ‰ç´€éŒ„</button>
    <div id="historyList"></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let dailyGoal = 0;
    let consumed = 0;
    let foodHistory = [];
    let currentDateKey = ""; 

    function getLocalYYYYMMDD(dateObj = new Date()) {
        const tzOffset = dateObj.getTimezoneOffset() * 60000;
        return (new Date(dateObj - tzOffset)).toISOString().split('T')[0];
    }

    window.onload = () => {
        currentDateKey = getLocalYYYYMMDD();
        document.getElementById('historyDate').value = currentDateKey;
        loadSettings();
        loadHistory(currentDateKey);
        updateDashboard();
    };

    window.calculateTDEE = function() {
        const gender = document.getElementById('gender').value;
        const age = parseInt(document.getElementById('age').value);
        const height = parseInt(document.getElementById('height').value);
        const weight = parseInt(document.getElementById('weight').value);
        if(!height || !weight) { alert("è«‹å¡«å¯«èº«é«˜å’Œé«”é‡å–”ï¼"); return; }

        let bmr = (10 * weight) + (6.25 * height) - (5 * age);
        bmr = (gender === 'female') ? bmr - 161 : bmr + 5;
        dailyGoal = Math.round(bmr * 1.375);
        
        localStorage.setItem('calorieGoal', dailyGoal);
        localStorage.setItem('userProfile', JSON.stringify({gender, age, height, weight}));
        alert(`è¨­å®šå®Œæˆï¼å»ºè­°ç†±é‡ç´„ç‚º ${dailyGoal} å¤§å¡ã€‚`);
        updateDashboard();
    };

    function loadSettings() {
        const savedGoal = localStorage.getItem('calorieGoal');
        if(savedGoal) dailyGoal = parseInt(savedGoal);
        const profile = JSON.parse(localStorage.getItem('userProfile'));
        if(profile) {
            document.getElementById('gender').value = profile.gender;
            document.getElementById('age').value = profile.age;
            document.getElementById('height').value = profile.height;
            document.getElementById('weight').value = profile.weight;
        }
    }

    function loadHistory(dateStr) {
        const savedHistory = localStorage.getItem('foodHistory_' + dateStr);
        if(savedHistory) {
            foodHistory = JSON.parse(savedHistory);
            consumed = foodHistory.reduce((total, item) => total + item.calories, 0);
        } else {
            foodHistory = [];
            consumed = 0;
        }
    }

    window.changeDate = function() {
        currentDateKey = document.getElementById('historyDate').value;
        loadHistory(currentDateKey);
        updateDashboard();
    }

    function updateDashboard() {
        document.getElementById('dailyGoalDisplay').innerText = dailyGoal;
        document.getElementById('consumedDisplay').innerText = consumed;
        const remaining = dailyGoal - consumed;
        const remainElem = document.getElementById('remainingDisplay');
        remainElem.innerText = remaining;
        remainElem.style.color = remaining < 0 ? '#dc3545' : '#28a745';
        renderHistoryList();
    }

    document.getElementById('imageInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById('preview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    });

    async function fileToGenerativePart(file) {
        const base64EncodedDataPromise = new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });
        return { inlineData: { data: await base64EncodedDataPromise, mimeType: file.type } };
    }

    // --- æ–°å¢ï¼šå°‡åœ–ç‰‡å£“ç¸®æˆæ­£æ–¹å½¢å°ç¸®åœ–çš„é­”æ³• ---
    function compressImage(file, maxSize = 300) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // è¨ˆç®—ç­‰æ¯”ä¾‹ç¸®å°çš„å°ºå¯¸
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // è¼¸å‡ºç‚ºå£“ç¸®éçš„ JPEG åœ–ç‰‡ (å“è³ª 0.7)
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    window.analyzeFood = async function() {
        const apiKey = document.getElementById('apiKey').value;
        const fileInput = document.getElementById('imageInput');
        const hintInput = document.getElementById('foodHint').value; 
        const mealType = document.getElementById('mealType').value; 
        const loadingDiv = document.getElementById('loading');

        if (!apiKey) { alert("è¨˜å¾—å…ˆè¼¸å…¥ API Key å–”ï¼"); return; }
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸ä¸€å¼µé¤é»ç…§ç‰‡ï¼"); return; }
        if (dailyGoal === 0) { alert("è«‹å…ˆåœ¨ä¸Šé¢å®Œæˆã€Œæˆ‘çš„å°ˆå±¬æ•¸å€¼ã€è¨­å®šä¸¦å„²å­˜ï¼"); return; }

        loadingDiv.style.display = 'block';

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-2.5-flash", 
                generationConfig: { responseMimeType: "application/json" }
            });

            let hintInstruction = "";
            if (hintInput.trim() !== "") {
                hintInstruction = `ã€é‡è¦æç¤ºã€‘ï¼šä½¿ç”¨è€…è¡¨ç¤ºé€™ä»½é¤é»åŒ…å«ã€Œ${hintInput}ã€ã€‚è«‹å‹™å¿…åƒè€ƒé€™å€‹æç¤ºä¾†è¾¨è­˜åœ–ç‰‡å…§å®¹ä¸¦ä¼°ç®—ç†±é‡ã€‚`;
            }

            const prompt = `ä½ æ˜¯ä¸€ä½ç†Ÿæ‚‰å°ç£å°åƒçš„ç‡Ÿé¤Šå°ˆå®¶ã€‚è«‹è¾¨è­˜åœ–ç‰‡ä¸­çš„ã€Œæ‰€æœ‰é£Ÿç‰©ã€ï¼Œä¸¦ä¼°ç®—ç¸½ç†±é‡ã€‚
            ${hintInstruction}
            å›å‚³æ ¼å¼å¿…é ˆæ˜¯æ¨™æº–çš„ JSONï¼š
            {
                "food_name": "èœè‰²ç¸½ç¨±",
                "calories": ç¸½ç†±é‡æ•¸å­— (å¿…é ˆæ˜¯ç´”ç²¹çš„ã€Œæ•´æ•¸æ•¸å­—ã€),
                "description": "è«‹è©³ç´°åˆ—å‡ºã€æ¯ä¸€æ¨£é£Ÿç‰©çš„å€‹åˆ¥ä¼°ç®—ç†±é‡ã€‘ï¼Œä¸¦ç°¡å–®èªªæ˜ç‡Ÿé¤Šç‹€æ…‹ã€‚"
            }
            æ³¨æ„ï¼šé€™æ˜¯é£Ÿç‰©ç…§ç‰‡ï¼Œè«‹çµ¦å‡ºåˆç†çš„ä¼°ç®—æ•´æ•¸ï¼Œcalories çµ•å°ä¸å¯ä»¥å¡«å¯« 0ã€‚`;
            
            const file = fileInput.files[0];
            const imagePart = await fileToGenerativePart(file);
            
            // åŒæ™‚å·å·æŠŠåœ–ç‰‡ç¸®å°æº–å‚™å­˜æª”
            const thumbnailDataUrl = await compressImage(file);

            const result = await model.generateContent([prompt, imagePart]);
            const responseText = await result.response.text();
            
            const foodData = JSON.parse(responseText);

            if(foodData.calories > 0) {
                foodData.meal_type = mealType;
                foodData.thumbnail = thumbnailDataUrl; // å°‡ç¸®åœ–å­˜å…¥è³‡æ–™ä¸­
                
                foodHistory.push(foodData);
                consumed += foodData.calories;
                
                localStorage.setItem('foodHistory_' + currentDateKey, JSON.stringify(foodHistory));
                
                document.getElementById('foodHint').value = ""; 
                document.getElementById('imageInput').value = ""; 
                document.getElementById('preview').style.display = 'none';
                
                updateDashboard();
            } else {
                alert("å°G çœ‹ä¸å‡ºé€™æ˜¯é£Ÿç‰©ï¼Œè«‹æ›ä¸€å¼µç…§ç‰‡è©¦è©¦å–”ï¼");
            }

        } catch (error) {
            console.error(error);
            alert("å“å‘€ï¼Œåˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤äº†ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ˜¯ API Key æ˜¯å¦æ­£ç¢ºã€‚");
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    window.deleteSingleItem = function(index) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†é¤é»ç´€éŒ„å—ï¼Ÿ")) {
            consumed -= foodHistory[index].calories;
            foodHistory.splice(index, 1);
            
            if (foodHistory.length === 0) {
                localStorage.removeItem('foodHistory_' + currentDateKey);
                consumed = 0;
            } else {
                localStorage.setItem('foodHistory_' + currentDateKey, JSON.stringify(foodHistory));
            }
            updateDashboard();
        }
    }

    function renderHistoryList() {
        const listDiv = document.getElementById('historyList');
        listDiv.innerHTML = '';
        
        if (foodHistory.length === 0) {
            listDiv.innerHTML = '<p style="text-align: center; color: #888;">é€™å¤©é‚„æ²’æœ‰ç´€éŒ„å–”ï¼</p>';
            return;
        }

        foodHistory.forEach((item, index) => {
            // æ–°æ’ç‰ˆï¼šå·¦é‚Šæ”¾ç¸®åœ–ï¼Œå³é‚Šæ”¾æ–‡å­—
            const imgSrc = item.thumbnail ? item.thumbnail : 'https://via.placeholder.com/80?text=No+Image';
            
            listDiv.innerHTML += `
                <div class="history-item">
                    <img src="${imgSrc}" alt="é£Ÿç‰©ç…§ç‰‡" class="history-photo">
                    <div class="history-content">
                        <div class="history-header">
                            <div>
                                <span class="meal-tag">${item.meal_type || 'æœªåˆ†é¡'}</span>
                                <strong style="display:block; font-size: 16px;">${item.food_name}</strong>
                            </div>
                            <span style="color: #dc3545; font-weight: bold; font-size: 18px;">+${item.calories} å¡</span>
                        </div>
                        <div class="history-desc">${item.description}</div>
                        <button class="delete-btn" onclick="deleteSingleItem(${index})">åˆªé™¤</button>
                    </div>
                </div>
            `;
        });
    }

    window.clearHistory = function() {
        if(confirm(`ç¢ºå®šè¦æ¸…é™¤ ${currentDateKey} çš„ã€Œæ‰€æœ‰ã€é£²é£Ÿç´€éŒ„å—ï¼Ÿ`)) {
            localStorage.removeItem('foodHistory_' + currentDateKey);
            foodHistory = [];
            consumed = 0;
            updateDashboard();
        }
    }
</script>

</body>
</html>