<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ˆå±¬é£²é£Ÿæ—¥è¨˜</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f0f4f8; color: #333; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; color: #444; }
        input[type="number"], input[type="text"], input[type="password"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        button { display: block; width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 15px; font-weight: bold; }
        button:hover { background: #0056b3; }
        
        .dashboard { display: flex; justify-content: space-between; text-align: center; background: #eef2f5; padding: 15px; border-radius: 8px; margin-top: 15px;}
        .stat { flex: 1; }
        .stat span { display: block; font-size: 24px; font-weight: bold; color: #007bff; }
        .stat.remaining span { color: #28a745; }
        .stat.consumed span { color: #dc3545; }

        .macro-container { margin-top: 15px; background: #fff; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; text-align: center; }
        .macro-title { font-weight: bold; margin-bottom: 10px; font-size: 14px; color: #555; }
        .macro-bar { display: flex; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px; background: #eee;}
        .bar-carbs { background: #ffc107; transition: width 0.5s; }
        .bar-protein { background: #28a745; transition: width 0.5s; }
        .bar-fat { background: #dc3545; transition: width 0.5s; }
        .macro-labels { display: flex; justify-content: space-between; font-size: 13px; font-weight: bold;}
        
        .macro-remaining-box { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; text-align: center;}
        .macro-stat { flex: 1; font-size: 13px; color: #666;}
        .macro-stat span { display: block; font-size: 18px; font-weight: bold; margin-top: 3px; margin-bottom: 3px;}
        .macro-stat small { font-size: 11px; color: #999;}
        
        #overCalorieWarning { display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; color: #856404; text-align: center; font-weight: bold; line-height: 1.5; }
        .exercise-highlight { color: #dc3545; font-size: 18px; }

        #previewContainer { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc; }
        .loading { text-align: center; display: none; color: #ff8c00; font-weight: bold; margin-top: 10px;}
        
        .history-item { background: #fff8e1; padding: 15px; border-left: 4px solid #ffc107; margin-top: 10px; border-radius: 4px; display: flex; gap: 15px; position: relative; align-items: flex-start;}
        .history-photos-container { display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; width: 70px;}
        .history-photo { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .history-content { flex: 1; display: flex; flex-direction: column; }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;}
        .history-desc { font-size: 13px; color: #555; white-space: pre-line; margin-bottom: 5px; line-height: 1.4;}
        
        .history-macros { font-size: 12px; color: #666; background: #fff; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-bottom: 10px; border: 1px solid #eee;}
        
        .meal-tag { background: #ffe082; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #d84315; display: inline-block;}
        .delete-btn { width: auto; padding: 5px 10px; background: #dc3545; font-size: 13px; margin-top: auto; align-self: flex-end;}
        .delete-btn:hover { background: #c82333; }
        .date-picker-container { text-align: center; margin-bottom: 15px; background: #eef2f5; padding: 10px; border-radius: 8px;}
        #bmiResultBox { margin-top: 15px; padding: 15px; background: #eef2f5; border-radius: 8px; text-align: center; display: none; border: 1px dashed #ccc; }
    </style>
</head>
<body>

<div class="card">
    <input type="password" id="apiKey" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Gemini API Key">
</div>

<div class="card">
    <h2>1ï¸âƒ£ æˆ‘çš„å°ˆå±¬æ•¸å€¼èˆ‡ç›®æ¨™</h2>
    <div style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>æ€§åˆ¥</label><select id="gender"><option value="female" selected>å¥³æ€§</option><option value="male">ç”·æ€§</option></select></div>
        <div style="flex: 1;"><label>å¹´é½¡</label><input type="number" id="age" value="45"></div>
    </div>
    <div style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>èº«é«˜ (cm)</label><input type="number" id="height" placeholder="ä¾‹å¦‚: 160"></div>
        <div style="flex: 1;"><label>é«”é‡ (kg)</label><input type="number" id="weight" placeholder="ä¾‹å¦‚: 55"></div>
    </div>
    
    <div style="margin-top: 10px;">
        <label>æˆ‘çš„ç›®æ¨™ ğŸ¯</label>
        <select id="goalType" style="background-color: #fdf5e6;">
            <option value="maintain" selected>ç¶­æŒç¾ç‹€ (æ­£å¸¸é£²é£Ÿ)</option>
            <option value="mild_loss">æº«å’Œæ¸›é‡ (æ¯æ—¥æ¸›å°‘ 300 å¤§å¡)</option>
            <option value="aggressive_loss">ç©æ¥µæ¸›é‡ (æ¯æ—¥æ¸›å°‘ 500 å¤§å¡)</option>
        </select>
    </div>

    <button onclick="calculateTDEE()">å„²å­˜è¨­å®šä¸¦è¨ˆç®—ç›®æ¨™</button>
    
    <div id="bmiResultBox">
        <span style="font-size: 16px; color: #555;">å¦³ç›®å‰çš„ BMI å€¼ï¼š<strong id="bmiValue" style="font-size: 24px; color: #007bff;">0</strong></span><br>
        <span id="bmiStatus" style="font-size: 15px; font-weight: bold; margin-top: 8px; display: inline-block;"></span>
    </div>
</div>

<div class="card">
    <h2>2ï¸âƒ£ æ—¥å¸¸ç†±é‡èˆ‡ç‡Ÿé¤Šè¿½è¹¤</h2>
    <div class="dashboard">
        <div class="stat">æ¯æ—¥ç›®æ¨™<br><span id="dailyGoalDisplay">0</span></div>
        <div class="stat consumed">å·²æ”å–<br><span id="consumedDisplay">0</span></div>
        <div class="stat remaining">é‚„å¯åƒ<br><span id="remainingDisplay">0</span></div>
    </div>
    
    <div id="overCalorieWarning">
        âš ï¸ å“å‘€ï¼ä»Šå¤©ä¸å°å¿ƒè¶…æ¨™äº† <span id="overCalSpan" class="exercise-highlight">0</span> å¤§å¡ï¼<br>
        å¦‚æœè¦æ¶ˆè€—æ‰é€™äº›å¤šé¤˜çš„ç†±é‡ï¼Œå¤§ç´„éœ€è¦å»æ…¢è·‘ <span id="overJogSpan" class="exercise-highlight">0</span> åˆ†é˜å–”ï¼ğŸƒâ€â™€ï¸
    </div>
    
    <div class="macro-container">
        <div class="macro-title">ğŸ“Š ä»Šæ—¥ä¸‰å¤§ç‡Ÿé¤Šç´ ä½”æ¯”</div>
        <div class="macro-bar">
            <div id="barCarbs" class="bar-carbs" style="width: 0%;"></div>
            <div id="barProtein" class="bar-protein" style="width: 0%;"></div>
            <div id="barFat" class="bar-fat" style="width: 0%;"></div>
        </div>
        <div class="macro-labels">
            <span style="color: #b08d00;">ğŸš ç¢³æ°´ <span id="txtCarbs">0%</span></span>
            <span style="color: #28a745;">ğŸ¥© è›‹ç™½è³ª <span id="txtProtein">0%</span></span>
            <span style="color: #dc3545;">ğŸ¥‘ è„‚è‚ª <span id="txtFat">0%</span></span>
        </div>
        
        <div class="macro-remaining-box">
            <div class="macro-stat">ğŸš å‰©é¤˜ç¢³æ°´<br><span id="remCarbs" style="color:#b08d00;">0g</span><small>ç¸½ç›®æ¨™ <span id="goalCarbsDisplay">0</span>g</small></div>
            <div class="macro-stat">ğŸ¥© å‰©é¤˜è›‹ç™½è³ª<br><span id="remProtein" style="color:#28a745;">0g</span><small>ç¸½ç›®æ¨™ <span id="goalProteinDisplay">0</span>g</small></div>
            <div class="macro-stat">ğŸ¥‘ å‰©é¤˜è„‚è‚ª<br><span id="remFat" style="color:#dc3545;">0g</span><small>ç¸½ç›®æ¨™ <span id="goalFatDisplay">0</span>g</small></div>
        </div>
    </div>
</div>

<div class="card">
    <h2>3ï¸âƒ£ ç´€éŒ„é¤é»ç®—ç†±é‡</h2>
    <label>ğŸ“· æ‹ç…§ä¸Šå‚³ (é¸å¡«ï¼šå¯é¸å¤šå¼µï¼Œæ²’ç…§ç‰‡ä¹Ÿå¯ä¸å‚³)</label>
    <input type="file" id="imageInput" accept="image/*" multiple>
    <div id="previewContainer"></div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <div style="flex: 1;">
            <label>å“ªä¸€é¤ï¼Ÿ</label>
            <select id="mealType">
                <option value="æ—©é¤">æ—©é¤ ğŸ³</option>
                <option value="åˆé¤" selected>åˆé¤ ğŸ±</option>
                <option value="æ™šé¤">æ™šé¤ ğŸ½ï¸</option>
                <option value="é»å¿ƒ">é»å¿ƒ/å®µå¤œ ğŸ°</option>
            </select>
        </div>
        <div style="flex: 2;">
            <label>âœï¸ é¤é»å‚™è¨» / èœå (é¸å¡«)</label>
            <input type="text" id="foodHint" placeholder="ä¾‹ï¼šè‚‰ç‡¥ç±³ç²‰ (è‹¥ç„¡ç…§ç‰‡å‰‡å¿…å¡«)">
        </div>
    </div>
    
    <button id="analyzeBtn" onclick="analyzeFood()">ä¸Šå‚³åˆ†æ</button>
    <div id="loading" class="loading">å°G æ­£åœ¨èªçœŸå¹«å¦³åˆ†æç†±é‡èˆ‡ç‡Ÿé¤Šä¸­... ğŸ³</div>
</div>

<div class="card">
    <h2>ğŸ½ï¸ é£²é£Ÿåœ–é‘‘æŸ¥è©¢</h2>
    <div class="date-picker-container">
        <label style="display: inline-block; margin-top: 0;">ğŸ“… é¸æ“‡æ—¥æœŸï¼š</label>
        <input type="date" id="historyDate" onchange="changeDate()" style="width: auto; display: inline-block; margin-left: 10px;">
    </div>
    <button onclick="clearHistory()" style="background: #6c757d; margin-bottom: 15px;">ğŸ—‘ï¸ æ¸…é™¤ã€Œæ­¤æ—¥æœŸã€çš„æ‰€æœ‰ç´€éŒ„</button>
    <div id="historyList"></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let dailyGoal = 0;
    let goalCarbs = 0;
    let goalProtein = 0;
    let goalFat = 0;
    
    let consumed = 0;
    let foodHistory = [];
    let currentDateKey = ""; 

    function getLocalYYYYMMDD(dateObj = new Date()) {
        const tzOffset = dateObj.getTimezoneOffset() * 60000;
        return (new Date(dateObj - tzOffset)).toISOString().split('T')[0];
    }

    window.onload = () => {
        currentDateKey = getLocalYYYYMMDD();
        document.getElementById('historyDate').value = currentDateKey;
        loadSettings();
        loadHistory(currentDateKey);
        updateDashboard();
    };

    function showBMI(h, w) {
        const heightM = h / 100;
        const bmi = (w / (heightM * heightM)).toFixed(1);
        let bmiStatus = "";
        let statusColor = "";
        
        if (bmi < 18.5) { bmiStatus = "é«”é‡éè¼• ğŸª¶ (å»ºè­°å¤šè£œå……ç‡Ÿé¤Šå–”ï¼)"; statusColor = "#6c757d"; } 
        else if (bmi < 24) { bmiStatus = "å¥åº·é«”ä½ âœ¨ (éå¸¸æ¨™æº–ï¼Œç¹¼çºŒä¿æŒï¼)"; statusColor = "#28a745"; } 
        else if (bmi < 27) { bmiStatus = "ç¨å¾®éé‡ ğŸ¤ (è¦æ³¨æ„é£²é£Ÿå‡è¡¡å›‰ï¼)"; statusColor = "#d84315"; } 
        else { bmiStatus = "è‚¥èƒ–è­¦æˆ’ ğŸš¨ (å»ºè­°ç¨å¾®æ§åˆ¶ç†±é‡æ”å–å–”ï¼)"; statusColor = "#dc3545"; }

        document.getElementById('bmiResultBox').style.display = 'block';
        document.getElementById('bmiValue').innerText = bmi;
        document.getElementById('bmiStatus').innerText = bmiStatus;
        document.getElementById('bmiStatus').style.color = statusColor;
    }

    window.calculateTDEE = function() {
        const gender = document.getElementById('gender').value;
        const age = parseInt(document.getElementById('age').value);
        const height = parseInt(document.getElementById('height').value);
        const weight = parseInt(document.getElementById('weight').value);
        const goalType = document.getElementById('goalType').value;
        
        if(!height || !weight) { alert("è«‹å¡«å¯«èº«é«˜å’Œé«”é‡å–”ï¼"); return; }

        let bmr = (10 * weight) + (6.25 * height) - (5 * age);
        bmr = (gender === 'female') ? bmr - 161 : bmr + 5;
        
        // åŸºç¤ç¶­æŒç†±é‡ (è¼•åº¦æ´»å‹•)
        let tdee = bmr * 1.375;
        
        // æ ¹æ“šç›®æ¨™æ‰£é™¤ç†±é‡èµ¤å­—
        if (goalType === 'mild_loss') {
            tdee -= 300;
        } else if (goalType === 'aggressive_loss') {
            tdee -= 500;
        }
        
        // ä¿è­·æ©Ÿåˆ¶ï¼šç†±é‡æœ€ä½ä¸å»ºè­°ä½æ–¼ 1200 å¤§å¡
        dailyGoal = Math.max(Math.round(tdee), 1200);
        
        // ç”¨æ–°çš„ç›®æ¨™ç†±é‡ä¾†è¨ˆç®—ä¸‰å¤§ç‡Ÿé¤Šç´ 
        goalCarbs = Math.round((dailyGoal * 0.50) / 4);
        goalProtein = Math.round((dailyGoal * 0.20) / 4);
        goalFat = Math.round((dailyGoal * 0.30) / 9);
        
        localStorage.setItem('calorieGoal', dailyGoal);
        localStorage.setItem('macroGoals', JSON.stringify({carbs: goalCarbs, protein: goalProtein, fat: goalFat}));
        localStorage.setItem('userProfile', JSON.stringify({gender, age, height, weight, goalType}));
        
        showBMI(height, weight);
        
        // ä¾ç…§ä¸åŒç›®æ¨™çµ¦äºˆä¸åŒæç¤º
        let alertMsg = `è¨­å®šå®Œæˆï¼\nä¾ç…§æ‚¨çš„ç›®æ¨™ï¼Œæ¯æ—¥å»ºè­°æ”å–ç†±é‡èª¿æ•´ç‚º ${dailyGoal} å¤§å¡ã€‚`;
        if (goalType !== 'maintain') {
            alertMsg += `\n(å·²è‡ªå‹•ç‚ºæ‚¨æ‰£é™¤æ¸›é‡æ‰€éœ€çš„ç†±é‡èµ¤å­—å–”ï¼ğŸ’ª)`;
        }
        alert(alertMsg);
        
        updateDashboard();
    };

    function loadSettings() {
        const savedGoal = localStorage.getItem('calorieGoal');
        if(savedGoal) dailyGoal = parseInt(savedGoal);
        
        const savedMacros = JSON.parse(localStorage.getItem('macroGoals'));
        if(savedMacros) {
            goalCarbs = savedMacros.carbs;
            goalProtein = savedMacros.protein;
            goalFat = savedMacros.fat;
        }

        const profile = JSON.parse(localStorage.getItem('userProfile'));
        if(profile) {
            document.getElementById('gender').value = profile.gender;
            document.getElementById('age').value = profile.age;
            document.getElementById('height').value = profile.height;
            document.getElementById('weight').value = profile.weight;
            if(profile.goalType) {
                document.getElementById('goalType').value = profile.goalType;
            }
            if(profile.height && profile.weight) showBMI(profile.height, profile.weight);
        }
    }

    function loadHistory(dateStr) {
        const savedHistory = localStorage.getItem('foodHistory_' + dateStr);
        if(savedHistory) {
            foodHistory = JSON.parse(savedHistory);
            consumed = foodHistory.reduce((total, item) => total + item.calories, 0);
        } else {
            foodHistory = [];
            consumed = 0;
        }
    }

    window.changeDate = function() {
        currentDateKey = document.getElementById('historyDate').value;
        loadHistory(currentDateKey);
        updateDashboard();
    }

    function updateDashboard() {
        document.getElementById('dailyGoalDisplay').innerText = dailyGoal;
        document.getElementById('consumedDisplay').innerText = consumed;
        const remaining = dailyGoal - consumed;
        const remainElem = document.getElementById('remainingDisplay');
        remainElem.innerText = remaining;
        remainElem.style.color = remaining < 0 ? '#dc3545' : '#28a745';

        const overWarningDiv = document.getElementById('overCalorieWarning');
        if (remaining < 0 && dailyGoal > 0) {
            const overCal = Math.abs(remaining);
            const userWeight = parseInt(document.getElementById('weight').value) || 55;
            // ç°¡å–®å…¬å¼ï¼šæ…¢è·‘(7 METs) æ¯å…¬æ–¤æ¯åˆ†é˜ç´„æ¶ˆè€— 0.1225 å¤§å¡
            const jogMins = Math.round(overCal / (0.1225 * userWeight));
            
            document.getElementById('overCalSpan').innerText = overCal;
            document.getElementById('overJogSpan').innerText = jogMins;
            overWarningDiv.style.display = 'block';
        } else {
            overWarningDiv.style.display = 'none';
        }

        let sumCarbs = 0, sumProtein = 0, sumFat = 0;
        foodHistory.forEach(item => {
            sumCarbs += (item.carbs_g || 0);
            sumProtein += (item.protein_g || 0);
            sumFat += (item.fat_g || 0);
        });

        const calCarbs = sumCarbs * 4;
        const calProtein = sumProtein * 4;
        const calFat = sumFat * 9;
        const totalMacroCal = calCarbs + calProtein + calFat;

        let pctCarbs = 0, pctProtein = 0, pctFat = 0;
        if (totalMacroCal > 0) {
            pctCarbs = Math.round((calCarbs / totalMacroCal) * 100);
            pctProtein = Math.round((calProtein / totalMacroCal) * 100);
            pctFat = Math.round((calFat / totalMacroCal) * 100);
        }

        document.getElementById('barCarbs').style.width = pctCarbs + '%';
        document.getElementById('barProtein').style.width = pctProtein + '%';
        document.getElementById('barFat').style.width = pctFat + '%';
        document.getElementById('txtCarbs').innerText = pctCarbs + '%';
        document.getElementById('txtProtein').innerText = pctProtein + '%';
        document.getElementById('txtFat').innerText = pctFat + '%';

        document.getElementById('goalCarbsDisplay').innerText = goalCarbs;
        document.getElementById('goalProteinDisplay').innerText = goalProtein;
        document.getElementById('goalFatDisplay').innerText = goalFat;

        const remCarbs = goalCarbs - sumCarbs;
        const remProtein = goalProtein - sumProtein;
        const remFat = goalFat - sumFat;

        const elCarbs = document.getElementById('remCarbs');
        elCarbs.innerText = remCarbs + 'g';
        elCarbs.style.color = remCarbs < 0 ? '#dc3545' : '#b08d00';

        const elProtein = document.getElementById('remProtein');
        elProtein.innerText = remProtein + 'g';
        elProtein.style.color = remProtein < 0 ? '#dc3545' : '#28a745';

        const elFat = document.getElementById('remFat');
        elFat.innerText = remFat + 'g';
        elFat.style.color = remFat < 0 ? '#dc3545' : '#d84315';

        renderHistoryList();
    }

    document.getElementById('imageInput').addEventListener('change', function(event) {
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.innerHTML = ''; 
        const files = event.target.files;
        if (files) {
            for(let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(files[i]);
            }
        }
    });

    function compressImage(file, maxSize = 120) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function compressForAI(file, maxSize = 800) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const base64String = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    resolve({ inlineData: { data: base64String, mimeType: 'image/jpeg' } });
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    window.analyzeFood = async function() {
        const apiKey = document.getElementById('apiKey').value;
        const fileInput = document.getElementById('imageInput');
        const hintInput = document.getElementById('foodHint').value.trim(); 
        const mealType = document.getElementById('mealType').value; 
        const loadingDiv = document.getElementById('loading');
        
        const files = fileInput.files;
        const hasPhotos = files.length > 0;

        if (!apiKey) { alert("è¨˜å¾—å…ˆè¼¸å…¥ API Key å–”ï¼"); return; }
        if (!hasPhotos && hintInput === "") { alert("è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç…§ç‰‡ï¼Œæˆ–è€…åœ¨å‚™è¨»æ¬„æ‰“å­—å–”ï¼"); return; }
        if (dailyGoal === 0) { alert("è«‹å…ˆåœ¨ä¸Šé¢å®Œæˆã€Œæˆ‘çš„å°ˆå±¬æ•¸å€¼ã€è¨­å®šä¸¦å„²å­˜ï¼"); return; }

        loadingDiv.style.display = 'block';

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-2.5-flash", 
                generationConfig: { responseMimeType: "application/json" }
            });

            let promptParts = [];
            let thumbnailsArray = [];

            const jsonFormat = `{
                "food_name": "èœè‰²ç¸½ç¨±",
                "calories": ç¸½ç†±é‡(æ•´æ•¸),
                "carbs_g": ç¢³æ°´åŒ–åˆç‰©ç¸½å…‹æ•¸(æ•´æ•¸),
                "protein_g": è›‹ç™½è³ªç¸½å…‹æ•¸(æ•´æ•¸),
                "fat_g": è„‚è‚ªç¸½å…‹æ•¸(æ•´æ•¸),
                "description": "è«‹è©³ç´°åˆ—å‡ºã€æ¯ä¸€æ¨£é£Ÿç‰©çš„å€‹åˆ¥ä¼°ç®—ç†±é‡ã€‘ï¼Œä¸¦ç°¡å–®èªªæ˜ç‡Ÿé¤Šçµ„æˆ"
            }`;

            if (hasPhotos) {
                let hintInstruction = hintInput !== "" ? `ã€æç¤ºã€‘ï¼šåŒ…å«ã€Œ${hintInput}ã€ã€‚` : "";
                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­ç‡Ÿé¤Šå°ˆå®¶ã€‚è«‹è©•ä¼°åœ–ç‰‡ä¸­æ‰€æœ‰é£Ÿç‰©çš„ç¸½ç†±é‡èˆ‡ä¸‰å¤§ç‡Ÿé¤Šç´ å…¬å…‹æ•¸ã€‚${hintInstruction}
                å›å‚³æ ¼å¼å¿…é ˆæ˜¯åš´æ ¼çš„ JSONï¼š${jsonFormat}
                è«‹çµ¦å‡ºåˆç†çš„ä¼°ç®—æ•´æ•¸ï¼Œä¸è¦å¡« 0ã€‚`;
                
                promptParts.push(prompt);
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    promptParts.push(await compressForAI(file));
                    thumbnailsArray.push(await compressImage(file)); 
                }
            } else {
                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­ç‡Ÿé¤Šå°ˆå®¶ã€‚è«‹æ ¹æ“šæè¿°ï¼šã€Œ${hintInput}ã€ï¼Œä¼°ç®—ç¸½ç†±é‡èˆ‡ä¸‰å¤§ç‡Ÿé¤Šç´ å…¬å…‹æ•¸ã€‚
                å›å‚³æ ¼å¼å¿…é ˆæ˜¯åš´æ ¼çš„ JSONï¼š${jsonFormat}
                è«‹çµ¦å‡ºåˆç†çš„ä¼°ç®—æ•´æ•¸ï¼Œä¸è¦å¡« 0ã€‚`;
                promptParts.push(prompt);
            }

            const result = await model.generateContent(promptParts);
            const responseText = await result.response.text();
            const foodData = JSON.parse(responseText);

            if(foodData.calories > 0) {
                foodData.meal_type = mealType;
                foodData.thumbnails = thumbnailsArray; 
                
                foodHistory.push(foodData);
                consumed += foodData.calories;
                
                localStorage.setItem('foodHistory_' + currentDateKey, JSON.stringify(foodHistory));
                
                document.getElementById('foodHint').value = ""; 
                fileInput.value = ""; 
                document.getElementById('previewContainer').innerHTML = ''; 
                
                updateDashboard();
                
                const userWeight = parseInt(document.getElementById('weight').value) || 55;
                const walkMins = Math.round(foodData.calories / (0.07525 * userWeight)); 
                
                alert(`ğŸ‰ åˆ†æå®Œæˆï¼\n\né€™ä»½ã€${foodData.food_name}ã€‘å¤§ç´„æ˜¯ ${foodData.calories} å¤§å¡ã€‚\n\nğŸ’¡ è¶£å‘³æ›ç®—ï¼šå¦‚æœè¦æ¶ˆè€—ã€Œé€™å–®ç¨ä¸€é¤ã€çš„ç†±é‡ï¼Œå¤§ç´„ç­‰æ–¼è¦èµ° ${walkMins} åˆ†é˜çš„è·¯å–”ï¼\n\n(å·²å¹«å¦³è‡ªå‹•æ‰£é™¤ä»Šæ—¥é¡åº¦ï¼Œè©³ç´°ç†±é‡èˆ‡ç‡Ÿé¤Šç´ æ˜ç´°è«‹å¾€ä¸‹æ»‘æŸ¥çœ‹)`);
                
            } else {
                alert("å°G ç„¡æ³•ä¼°ç®—ç†±é‡ï¼Œè«‹å˜—è©¦æä¾›æ›´è©³ç´°çš„æè¿°æˆ–ç…§ç‰‡å–”ï¼");
            }

        } catch (error) {
            console.error("è©³ç´°éŒ¯èª¤:", error);
            const errStr = error.toString();
            if (errStr.includes("429") || errStr.includes("Quota")) {
                alert("ğŸ’¦ å°G éœ€è¦å–˜å£æ°£ï¼è«‹ç­‰ 1 åˆ†é˜å¾Œå†è©¦ä¸€æ¬¡å–”ï¼");
            } else {
                alert("å“å‘€ï¼Œåˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤äº†ï¼è«‹æª¢æŸ¥ç¶²è·¯æˆ– API Keyã€‚");
            }
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    window.deleteSingleItem = function(index) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†é¤é»ç´€éŒ„å—ï¼Ÿ")) {
            consumed -= foodHistory[index].calories;
            foodHistory.splice(index, 1);
            if (foodHistory.length === 0) {
                localStorage.removeItem('foodHistory_' + currentDateKey);
                consumed = 0;
            } else {
                localStorage.setItem('foodHistory_' + currentDateKey, JSON.stringify(foodHistory));
            }
            updateDashboard();
        }
    }

    function renderHistoryList() {
        const listDiv = document.getElementById('historyList');
        listDiv.innerHTML = '';
        
        if (foodHistory.length === 0) {
            listDiv.innerHTML = '<p style="text-align: center; color: #888;">é€™å¤©é‚„æ²’æœ‰ç´€éŒ„å–”ï¼</p>';
            return;
        }

        foodHistory.forEach((item, index) => {
            let imagesHtml = '';
            if (item.thumbnails && item.thumbnails.length > 0) {
                item.thumbnails.forEach(src => {
                    imagesHtml += `<img src="${src}" alt="é£Ÿç‰©ç…§ç‰‡" class="history-photo">`;
                });
            } else {
                imagesHtml = `<div class="history-photo" style="background:#f8f9fa; display:flex; align-items:center; justify-content:center; font-size:12px; color:#888; border: 1px dashed #ccc;">âœï¸ ç­†è¨˜</div>`;
            }

            let macrosHtml = '';
            if(item.carbs_g !== undefined) {
                macrosHtml = `<div class="history-macros">ğŸš ç¢³æ°´ ${item.carbs_g}g | ğŸ¥© è›‹ç™½è³ª ${item.protein_g}g | ğŸ¥‘ è„‚è‚ª ${item.fat_g}g</div>`;
            }

            listDiv.innerHTML += `
                <div class="history-item">
                    <div class="history-photos-container">${imagesHtml}</div>
                    <div class="history-content">
                        <div class="history-header">
                            <div>
                                <span class="meal-tag">${item.meal_type || 'æœªåˆ†é¡'}</span>
                                <strong style="display:block; font-size: 16px;">${item.food_name}</strong>
                            </div>
                            <span style="color: #dc3545; font-weight: bold; font-size: 18px;">+${item.calories} å¡</span>
                        </div>
                        ${macrosHtml}
                        <div class="history-desc">${item.description}</div>
                        <button class="delete-btn" onclick="deleteSingleItem(${index})">åˆªé™¤</button>
                    </div>
                </div>
            `;
        });
    }

    window.clearHistory = function() {
        if(confirm(`ç¢ºå®šè¦æ¸…é™¤ ${currentDateKey} çš„ã€Œæ‰€æœ‰ã€é£²é£Ÿç´€éŒ„å—ï¼Ÿ`)) {
            localStorage.removeItem('foodHistory_' + currentDateKey);
            foodHistory = [];
            consumed = 0;
            updateDashboard();
        }
    }
</script>

</body>
</html>